stages:
  - secret-detection
  - health-check

variables:
  SECRET_DETECTION_ENABLED: "true"

secret_detection:
  stage: secret-detection

services_health_check:
  stage: health-check
  tags:
    - anngu
  image: ubuntu:latest
  variables:
    DOCKER_HOST_IP: "host.docker.internal"
  before_script:
    - apt-get update -qq
    - apt-get install -y netcat-openbsd curl
    - echo "Detecting Docker host IP..."
    - |
      if nc -z host.docker.internal 5432 2>/dev/null; then
        export HOST_IP="host.docker.internal"
      elif nc -z 172.17.0.1 5432 2>/dev/null; then
        export HOST_IP="172.17.0.1"
      elif nc -z 192.168.65.1 5432 2>/dev/null; then
        export HOST_IP="192.168.65.1"
      else
        export HOST_IP=$(ip route show default | awk '/default/ {print $3}')
      fi
      echo "Using host IP: $HOST_IP"

      # Set environment based on branch or manual variable
      if [ "$CI_COMMIT_BRANCH" = "main" ] && [ -z "$ENVIRONMENT" ]; then
        export ENVIRONMENT="production"
        echo "Setting environment to production for main branch"
      fi
      echo "Environment: ${ENVIRONMENT:-development}"
  script:
    - HOST_IP=${HOST_IP} ENVIRONMENT=${ENVIRONMENT} ./scripts/health-check.sh
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: manual
  allow_failure: false
  timeout: 10 minutes

include:
  - template: Security/Secret-Detection.gitlab-ci.yml
