services:
  # Traefik reverse proxy with automatic SSL
  traefik:
    image: traefik:v2.10
    container_name: endo4life_traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    networks:
      - proxy
      - endo4life-network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - letsencrypt:/letsencrypt
    command:
      - --api.dashboard=true
      - --log.level=INFO
      - --providers.docker.network=proxy
      - --providers.docker.exposedByDefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entryPoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.http.tls.certresolver=letsencrypt
      - --certificatesresolvers.letsencrypt.acme.email=lovetruongan@gmail.com
      - --certificatesresolvers.letsencrypt.acme.tlschallenge=true
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.mydevopsproject2023.id.vn`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.service=api@internal"

  # PostgreSQL for Keycloak
  postgresql:
    image: postgres:15-alpine
    container_name: endo4life_postgres
    restart: always
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-elearning}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres123}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - endo4life-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PgAdmin with Traefik labels
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: endo4life_pgadmin
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@admin.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin123}
      PGADMIN_LISTEN_PORT: 80
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgresql
    networks:
      - proxy
      - endo4life-network
    labels:
      - "traefik.enable=true"
      # HTTPS router
      - "traefik.http.routers.pgadmin.rule=Host(`pgadmin.mydevopsproject2023.id.vn`)"
      - "traefik.http.routers.pgadmin.entrypoints=websecure"
      - "traefik.http.routers.pgadmin.tls.certresolver=letsencrypt"
      # HTTP to HTTPS redirect
      - "traefik.http.routers.pgadmin-http.rule=Host(`pgadmin.mydevopsproject2023.id.vn`)"
      - "traefik.http.routers.pgadmin-http.entrypoints=web"
      - "traefik.http.routers.pgadmin-http.middlewares=pgadmin-redirect"
      - "traefik.http.middlewares.pgadmin-redirect.redirectscheme.scheme=https"
      - "traefik.http.services.pgadmin.loadbalancer.server.port=80"
      - "traefik.docker.network=proxy"

  # Keycloak with Traefik labels
  keycloak:
    image: quay.io/keycloak/keycloak:21.0.1
    container_name: endo4life_keycloak
    restart: always
    command: start --proxy=edge --hostname=keycloak.mydevopsproject2023.id.vn --hostname-strict=false
    depends_on:
      postgresql:
        condition: service_healthy
    environment:
      # Keycloak admin
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin123}
      
      # Database configuration (Keycloak 23.0.6 format)
      - DB_VENDOR=postgres
      - DB_ADDR=postgresql
      - DB_DATABASE=${POSTGRES_DB:-elearning}
      - DB_USER=${POSTGRES_USER:-postgres}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-postgres123}
      
      # Proxy configuration
      - PROXY_ADDRESS_FORWARDING=true
      - KEYCLOAK_FRONTEND_URL=https://keycloak.mydevopsproject2023.id.vn
      
    volumes:
      - keycloak_data:/opt/keycloak/data
    networks:
      - proxy
      - endo4life-network
    labels:
      - "traefik.enable=true"
      # HTTPS router
      - "traefik.http.routers.keycloak.rule=Host(`keycloak.mydevopsproject2023.id.vn`)"
      - "traefik.http.routers.keycloak.entrypoints=websecure"
      - "traefik.http.routers.keycloak.tls.certresolver=letsencrypt"
      - "traefik.http.routers.keycloak.middlewares=keycloak-headers"
      - "traefik.http.middlewares.keycloak-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.keycloak-headers.headers.customrequestheaders.X-Forwarded-Port=443"
      - "traefik.http.middlewares.keycloak-headers.headers.customrequestheaders.X-Forwarded-Host=keycloak.mydevopsproject2023.id.vn"
      - "traefik.http.middlewares.keycloak-headers.headers.customrequestheaders.X-Forwarded-For="
      # HTTP to HTTPS redirect
      - "traefik.http.routers.keycloak-http.rule=Host(`keycloak.mydevopsproject2023.id.vn`)"
      - "traefik.http.routers.keycloak-http.entrypoints=web"
      - "traefik.http.routers.keycloak-http.middlewares=keycloak-redirect"
      - "traefik.http.middlewares.keycloak-redirect.redirectscheme.scheme=https"
      - "traefik.http.services.keycloak.loadbalancer.server.port=8080"
      - "traefik.docker.network=proxy"

  # MinIO with Traefik labels
  minio:
    image: minio/minio:RELEASE.2023-05-04T21-44-30Z
    container_name: endo4life_minio
    restart: always
    networks:
      - proxy
      - endo4life-network
    volumes:
      - minio_data:/data
    environment:
      - MINIO_ROOT_USER=${MINIO_USERNAME:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_PASSWORD:-minio123456}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        minio server /data --console-address ":9001"
    labels:
      - "traefik.enable=true"
      # MinIO API
      - "traefik.http.routers.minio-api.entrypoints=websecure"
      - "traefik.http.routers.minio-api.rule=Host(`minio-api.mydevopsproject2023.id.vn`)"
      - "traefik.http.routers.minio-api.service=minio-api"
      - "traefik.http.services.minio-api.loadbalancer.server.port=9000"
      # MinIO Console
      - "traefik.http.routers.minio-console.entrypoints=websecure"
      - "traefik.http.routers.minio-console.rule=Host(`minio.mydevopsproject2023.id.vn`)"
      - "traefik.http.routers.minio-console.service=minio-console"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9001"

volumes:
  postgres_data:
  pgadmin_data:
  keycloak_data:
  minio_data:
  letsencrypt:

networks:
  proxy:
    external: true
  endo4life-network:
    driver: bridge
